!function ($) { var pluginName = "yiiDynamicForm", regexID = /^(.+?)([-\d-]{1,})(.+)$/i, regexName = /(^.+?)([\[\d{1,}\]]{1,})(\[.+\]$)/i; $.fn.yiiDynamicForm = function (e) { return methods[e] ? methods[e].apply(this, Array.prototype.slice.call(arguments, 1)) : "object" != typeof e && e ? ($.error("Method " + e + " does not exist on jQuery.yiiDynamicForm"), !1) : methods.init.apply(this, arguments) }; var events = { beforeInsert: "beforeInsert", afterInsert: "afterInsert", beforeDelete: "beforeDelete", afterDelete: "afterDelete", limitReached: "limitReached" }, methods = { init: function (e) { return this.each(function () { e.template = _parseTemplate(e) }) }, addItem: function (e, t, i) { _addItem(e, t, i) }, deleteItem: function (e, t, i) { _deleteItem(e, t, i) }, updateContainer: function () { var widgetOptions = eval($(this).attr("data-dynamicform")); _updateAttributes(widgetOptions), _restoreSpecialJs(widgetOptions), _fixFormValidaton(widgetOptions) } }, _parseTemplate = function (widgetOptions) { var $template = $(widgetOptions.template); $template.find("div[data-dynamicform]").each(function () { var widgetOptions = eval($(this).attr("data-dynamicform")); if ($(widgetOptions.widgetItem).length > 1) { var item = $(this).find(widgetOptions.widgetItem).first()[0].outerHTML; $(this).find(widgetOptions.widgetBody).html(item) } }), $template.find("input, textarea, select").each(function () { if ($(this).is(":checkbox") || $(this).is(":radio")) { var e = $(this).is(":checkbox") ? "checkbox" : "radio", t = $(this).attr("name"), i = $template.find('input[type="hidden"][name="' + t + '"]').first(), a = $template.find('input[type="' + e + '"][name="' + t + '"]').length; i && 1 === a && ($(this).val(1), i.val(0)), $(this).prop("checked", !1) } else $(this).is("select") ? $(this).find("option:selected").removeAttr("selected") : $(this).val("") }); var yiiActiveFormData = $("#" + widgetOptions.formId).yiiActiveForm("data"); return void 0 !== yiiActiveFormData && void 0 !== yiiActiveFormData.settings && (void 0 !== yiiActiveFormData.settings.errorCssClass && yiiActiveFormData.settings.errorCssClass.length > 0 && $template.find("." + yiiActiveFormData.settings.errorCssClass).removeClass(yiiActiveFormData.settings.errorCssClass), void 0 !== yiiActiveFormData.settings.successCssClass && yiiActiveFormData.settings.successCssClass.length > 0 && $template.find("." + yiiActiveFormData.settings.successCssClass).removeClass(yiiActiveFormData.settings.successCssClass)), $template }, _getWidgetOptionsRoot = function (widgetOptions) { return eval($("." + widgetOptions.widgetContainer + " " + widgetOptions.widgetBody).parents("div[data-dynamicform]").last().attr("data-dynamicform")) }, _getLevel = function (e) { var t = e.parents("div[data-dynamicform]").length; return t = t < 0 ? 0 : t }, _count = function (e, t) { return e.closest("." + t.widgetContainer).find(t.widgetItem).length }, _createIdentifiers = function (e) { return new Array(e + 2).join("0").split("") }, _addItem = function (e, t, i) { var a = _count(i, e); a < e.limit ? ($toclone = 0 == a ? $(e.template) : $(e.widgetItem).first(), $newclone = $toclone.clone(!1, !1), $newclone.find("input, textarea, select").each(function () { $(this).val("") }), __distinctRecursive("[data-dynamicform^=dynamicform]", $newclone), "top" === e.insertPosition ? i.closest("." + e.widgetContainer).find(e.widgetBody).prepend($newclone) : i.closest("." + e.widgetContainer).find(e.widgetBody).append($newclone), _updateAttributes(e), _restoreSpecialJs(e), _fixFormValidaton(e), i.closest("." + e.widgetContainer).triggerHandler(events.afterInsert, $newclone)) : i.closest("." + e.widgetContainer).triggerHandler(events.limitReached, e.limit) }, __distinctRecursive = function (regex, $item) { var $items = $item.find(regex); $.each($items, function (i, item) { var formObject = eval($(item).data("dynamicform")), widgetItem = formObject.widgetItem; $(item).find(widgetItem + ":not(:nth-child(1))").remove(), __distinctRecursive(regex, $(item)) }) }, _removeValidations = function ($elem, widgetOptions, count) { if (count > 1) { $elem.find("div[data-dynamicform]").each(function () { for (var currentWidgetOptions = eval($(this).attr("data-dynamicform")), level = _getLevel($(this)), identifiers = _createIdentifiers(level), numItems = $(this).find(currentWidgetOptions.widgetItem).length, i = 1; i <= numItems - 1; i++) { var aux = identifiers; aux[level] = i, currentWidgetOptions.fields.forEach(function (e) { var t = e.id.replace("{}", aux.join("-")); "undefined" !== $("#" + currentWidgetOptions.formId).yiiActiveForm("find", t) && $("#" + currentWidgetOptions.formId).yiiActiveForm("remove", t) }) } }); var level = _getLevel($elem.closest("." + widgetOptions.widgetContainer)), widgetOptionsRoot = _getWidgetOptionsRoot(widgetOptions), identifiers = _createIdentifiers(level); identifiers[0] = $(widgetOptionsRoot.widgetItem).length - 1, identifiers[level] = count - 1, widgetOptions.fields.forEach(function (e) { var t = e.id.replace("{}", identifiers.join("-")); "undefined" !== $("#" + widgetOptions.formId).yiiActiveForm("find", t) && $("#" + widgetOptions.formId).yiiActiveForm("remove", t) }) } }, _deleteItem = function (e, t, i) { var a = _count(i, e); a > e.min && ($todelete = i.closest(e.widgetItem), !1 !== $("." + e.widgetContainer).triggerHandler(events.beforeDelete, $todelete) && (_removeValidations($todelete, e, a), $todelete.remove(), _updateAttributes(e), _restoreSpecialJs(e), _fixFormValidaton(e), $("." + e.widgetContainer).triggerHandler(events.afterDelete))) }, _updateAttrID = function ($elem, index) { var widgetOptions = eval($elem.closest("div[data-dynamicform]").attr("data-dynamicform")), id = $elem.attr("id"), newID = id; if (void 0 !== id) { var matches = id.match(regexID); if (matches && 4 === matches.length) { matches[2] = matches[2].substring(1, matches[2].length - 1); var identifiers = matches[2].split("-"); if (identifiers[0] = index, identifiers.length > 1) { var widgetsOptions = []; $elem.parents("div[data-dynamicform]").each(function (i) { widgetsOptions[i] = eval($(this).attr("data-dynamicform")) }), widgetsOptions = widgetsOptions.reverse(); for (var i = identifiers.length - 1; i >= 1; i--)void 0 !== widgetsOptions[i] && (identifiers[i] = $elem.closest(widgetsOptions[i].widgetItem).index()) } newID = matches[1] + "-" + identifiers.join("-") + "-" + matches[3], $elem.attr("id", newID) } else newID = id + index, $elem.attr("id", newID) } return id !== newID && null != widgetOptions && ($elem.closest(widgetOptions.widgetItem).find(".field-" + id).each(function () { $(this).removeClass("field-" + id).addClass("field-" + newID) }), $elem.closest(widgetOptions.widgetItem).find("label[for='" + id + "']").attr("for", newID)), newID }, _updateAttrName = function ($elem, index) { var name = $elem.attr("name"); if (void 0 !== name) { var matches = name.match(regexName); if (matches && 4 === matches.length) { matches[2] = matches[2].replace(/\]\[/g, "-").replace(/\]|\[/g, ""); var identifiers = matches[2].split("-"); if (identifiers[0] = index, identifiers.length > 1) { var widgetsOptions = []; $elem.parents("div[data-dynamicform]").each(function (i) { widgetsOptions[i] = eval($(this).attr("data-dynamicform")) }), widgetsOptions = widgetsOptions.reverse(); for (var i = identifiers.length - 1; i >= 1; i--)void 0 !== widgetsOptions[i] && (identifiers[i] = $elem.closest(widgetsOptions[i].widgetItem).index()) } name = matches[1] + "[" + identifiers.join("][") + "]" + matches[3], $elem.attr("name", name) } } return name }, _updateAttributes = function (e) { var t = _getWidgetOptionsRoot(e); $("." + t.widgetContainer + " " + t.widgetItem).each(function (e) { $(this); $(this).find("*").each(function () { _updateAttrID($(this), e), _updateAttrName($(this), e) }) }) }, _fixFormValidatonInput = function (e, t, i, a) { void 0 !== t && ((t = $.extend(!0, {}, t)).id = i, t.container = ".field-" + i, t.input = "#" + i, t.name = a, t.value = $("#" + i).val(), t.status = 0, "undefined" !== $("#" + e.formId).yiiActiveForm("find", i) && $("#" + e.formId).yiiActiveForm("remove", i), $("#" + e.formId).yiiActiveForm("add", t)) }, _fixFormValidaton = function (widgetOptions) { var widgetOptionsRoot = _getWidgetOptionsRoot(widgetOptions); $(widgetOptionsRoot.widgetBody).find("input, textarea, select").each(function () { var id = $(this).attr("id"), name = $(this).attr("name"); if (void 0 === id && "radio" == $(this).attr("type") && (id = $(this).parents().eq(2).attr("id")), void 0 !== id && void 0 !== name) { currentWidgetOptions = eval($(this).closest("div[data-dynamicform]").attr("data-dynamicform")); var matches = id.match(regexID); if (matches && 4 === matches.length) { matches[2] = matches[2].substring(1, matches[2].length - 1); var level = _getLevel($(this)), identifiers = _createIdentifiers(level - 1), baseID = matches[1] + "-" + identifiers.join("-") + "-" + matches[3], attribute = $("#" + currentWidgetOptions.formId).yiiActiveForm("find", baseID); _fixFormValidatonInput(currentWidgetOptions, attribute, id, name) } } }) }, _restoreKrajeeDepdrop = function ($elem) { var configDepdrop = $.extend(!0, {}, eval($elem.attr("data-krajee-depdrop"))), inputID = $elem.attr("id"), matchID = inputID.match(regexID); if (matchID && 4 === matchID.length) for (index = 0; index < configDepdrop.depends.length; ++index) { var match = configDepdrop.depends[index].match(regexID); match && 4 === match.length && (configDepdrop.depends[index] = match[1] + matchID[2] + match[3]) } $elem.depdrop(configDepdrop) }, _restoreSpecialJs = function (widgetOptions) { var widgetOptionsRoot = _getWidgetOptionsRoot(widgetOptions), $hasInputmask = $(widgetOptionsRoot.widgetItem).find("[data-plugin-inputmask]"); $hasInputmask.length > 0 && $hasInputmask.each(function () { $(this).inputmask("remove"), $(this).inputmask(eval($(this).attr("data-plugin-inputmask"))) }); var $hasDateTimepicker = $(widgetOptionsRoot.widgetItem).find("[data-krajee-kvdatetimepicker]"); $hasDateTimepicker.length > 0 && $hasDateTimepicker.each(function () { $(this).parent().removeData().datetimepicker("remove"), $(this).parent().datetimepicker(eval($(this).attr("data-krajee-kvdatetimepicker"))) }); var $hasDatepicker = $(widgetOptionsRoot.widgetItem).find("[data-krajee-kvdatepicker]"); $hasDatepicker.length > 0 && $hasDatepicker.each(function () { $(this).removeData().kvDatepicker("destroy"), $(this).kvDatepicker(eval($(this).attr("data-krajee-kvdatepicker"))) }); var $hasTimepicker = $(widgetOptionsRoot.widgetItem).find("[data-krajee-timepicker]"); $hasTimepicker.length > 0 && $hasTimepicker.each(function () { $(this).removeData().off(), $(this).parent().find(".bootstrap-timepicker-widget").remove(), $(this).unbind(), $(this).timepicker(eval($(this).attr("data-krajee-timepicker"))) }); var $hasMaskmoney = $(widgetOptionsRoot.widgetItem).find("[data-krajee-maskMoney]"); $hasMaskmoney.length > 0 && $hasMaskmoney.each(function () { $(this).parent().find("input").removeData().off(); var id = "#" + $(this).attr("id"), displayID = id + "-disp"; $(displayID).maskMoney("destroy"), $(displayID).maskMoney(eval($(this).attr("data-krajee-maskMoney"))), $(displayID).maskMoney("mask", parseFloat($(id).val())), $(displayID).on("change", function () { var e = $(displayID).maskMoney("unmasked")[0]; $(id).val(e), $(id).trigger("change") }) }); var $hasFileinput = $(widgetOptionsRoot.widgetItem).find("[data-krajee-fileinput]"); $hasFileinput.length > 0 && $hasFileinput.each(function () { $(this).fileinput(eval($(this).attr("data-krajee-fileinput"))) }); var $hasTouchSpin = $(widgetOptionsRoot.widgetItem).find("[data-krajee-TouchSpin]"); $hasTouchSpin.length > 0 && $hasTouchSpin.each(function () { $(this).TouchSpin("destroy"), $(this).TouchSpin(eval($(this).attr("data-krajee-TouchSpin"))) }); var $hasTypehead = $(widgetOptionsRoot.widgetItem).find("[data-krajee-typeahead]"); $hasTypehead.length > 0 && $hasTypehead.each(function () { $(this).typeahead("destroy"); var e = $(this).attr("data-template"), t = $(this).attr("data-empty"), i = new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.obj.whitespace($(this).attr("data-display")), queryTokenizer: Bloodhound.tokenizers.whitespace, remote: { url: $(this).attr("data-url"), wildcard: "%QUERY" } }); void 0 !== e ? $(this).typeahead(null, { name: $(this).attr("id"), display: $(this).attr("data-display"), source: i, templates: { empty: [t], suggestion: Handlebars.compile(e) } }) : $(this).typeahead(null, { name: $(this).attr("id"), display: $(this).attr("data-display"), source: i }) }); var $hasSpectrum = $(widgetOptionsRoot.widgetItem).find("[data-krajee-spectrum]"); $hasSpectrum.length > 0 && $hasSpectrum.each(function () { var id = "#" + $(this).attr("id"), sourceID = id + "-source"; $(sourceID).spectrum("destroy"), $(sourceID).unbind(), $(id).unbind(); var configSpectrum = eval($(this).attr("data-krajee-spectrum")); configSpectrum.change = function (e) { jQuery(id).val(e.toString()) }, $(sourceID).attr("name", $(sourceID).attr("id")), $(sourceID).spectrum(configSpectrum), $(sourceID).spectrum("set", jQuery(id).val()), $(id).on("change", function () { $(sourceID).spectrum("set", jQuery(id).val()) }) }); var $hasDepdrop = $(widgetOptionsRoot.widgetItem).find("[data-krajee-depdrop]"); $hasDepdrop.length > 0 && $hasDepdrop.each(function () { void 0 === $(this).data("select2") && ($(this).removeData().off(), $(this).unbind(), _restoreKrajeeDepdrop($(this))) }); var $hasSelect2 = $(widgetOptionsRoot.widgetItem).find("[data-krajee-select2]"); $hasSelect2.length > 0 && $hasSelect2.each(function () { var id = $(this).attr("id"), $id = $("#" + id), configSelect2 = eval($(this).attr("data-krajee-select2")); $(this).data("select2") && $(this).select2("destroy"); var configDepdrop = $(this).data("depdrop"); configDepdrop && (configDepdrop = $.extend(!0, {}, configDepdrop), $(this).removeData().off(), $(this).unbind(), _restoreKrajeeDepdrop($(this))); var s2LoadingFunc = "undefined" != typeof initSelect2Loading ? initSelect2Loading : initS2Loading, s2OpenFunc = "undefined" != typeof initSelect2DropStyle ? initSelect2Loading : initS2Loading; $.when($("#" + id).select2(configSelect2)).done(s2LoadingFunc(id, ".select2-container--krajee")); var kvClose = "kv_close_" + id.replace(/\-/g, "_"); if ($("#" + id).on("select2:opening", function (e) { s2OpenFunc(id, kvClose, e) }), $id.on("select2:unselect", function () { window[kvClose] = !0 }), configDepdrop) { var loadingText = configDepdrop.loadingText ? configDepdrop.loadingText : "Loading ..."; initDepdropS2(id, loadingText) } $(".kv-plugin-loading").remove() }); var $hasCheckboxX = $(widgetOptionsRoot.widgetItem).find("[data-krajee-checkboxx]"); $hasCheckboxX.length > 0 && $hasCheckboxX.each(function () { if ("cbx-loading" == $(this).attr("class")) { var ckxOptions = eval($(this).attr("data-krajee-checkboxx")); $(this).checkboxX(ckxOptions) } }); var $hasRating = $(widgetOptionsRoot.widgetItem).find("[data-krajee-rating]"); $hasRating.length > 0 && $hasRating.each(function () { $(this).rating("destroy"), $(this).rating(eval($(this).attr("data-krajee-rating"))) }) } }(window.jQuery);